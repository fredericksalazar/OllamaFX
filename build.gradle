plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.0.14'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

group = 'com.org.ollamafx'
version = '0.4.0'

repositories {
    mavenCentral()
}

dependencies {
    implementation "io.github.ollama4j:ollama4j:1.0.100"
    implementation 'org.fxmisc.richtext:richtextfx:0.11.0'
    implementation 'org.jsoup:jsoup:1.17.2'
    implementation 'io.github.mkpaz:atlantafx-base:2.0.1'
    implementation 'com.github.oshi:oshi-core-java11:6.4.0'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'org.commonmark:commonmark:0.21.0'
    implementation 'org.slf4j:slf4j-nop:2.0.12' // Suppresses SLF4J warning
    
    // Icon Pack
    implementation 'org.kordamp.ikonli:ikonli-javafx:12.3.1'
    implementation 'org.kordamp.ikonli:ikonli-feather-pack:12.3.1'
    implementation 'org.kordamp.ikonli:ikonli-material2-pack:12.3.1'

    implementation 'org.kordamp.ikonli:ikonli-fontawesome5-pack:12.3.1'

    // Cross-platform natives for Shadow JAR
    runtimeOnly "org.openjfx:javafx-graphics:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-graphics:17.0.6:win"
    runtimeOnly "org.openjfx:javafx-base:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-base:17.0.6:win"
    runtimeOnly "org.openjfx:javafx-controls:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-controls:17.0.6:win"
    runtimeOnly "org.openjfx:javafx-fxml:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-fxml:17.0.6:win"
    runtimeOnly "org.openjfx:javafx-fxml:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-fxml:17.0.6:win"
    runtimeOnly "org.openjfx:javafx-web:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-web:17.0.6:win"
    runtimeOnly "org.openjfx:javafx-media:17.0.6:linux"
    runtimeOnly "org.openjfx:javafx-media:17.0.6:win"

    // Mac & Apple Silicon Support
    runtimeOnly "org.openjfx:javafx-graphics:17.0.6:mac"
    runtimeOnly "org.openjfx:javafx-graphics:17.0.6:mac-aarch64"
    runtimeOnly "org.openjfx:javafx-base:17.0.6:mac"
    runtimeOnly "org.openjfx:javafx-base:17.0.6:mac-aarch64"
    runtimeOnly "org.openjfx:javafx-controls:17.0.6:mac"
    runtimeOnly "org.openjfx:javafx-controls:17.0.6:mac-aarch64"
    runtimeOnly "org.openjfx:javafx-fxml:17.0.6:mac"
    runtimeOnly "org.openjfx:javafx-fxml:17.0.6:mac-aarch64"
    runtimeOnly "org.openjfx:javafx-web:17.0.6:mac"
    runtimeOnly "org.openjfx:javafx-web:17.0.6:mac-aarch64"
    runtimeOnly "org.openjfx:javafx-media:17.0.6:mac"
    runtimeOnly "org.openjfx:javafx-media:17.0.6:mac-aarch64"
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

javafx {
    version = "17.0.6"
    modules = [ 'javafx.controls', 'javafx.fxml', 'javafx.web']
}

application {
    mainClass = 'com.org.ollamafx.Main'
    applicationDefaultJvmArgs = ['-Xdock:name=OllamaFX', '-Xdock:icon=src/main/resources/icons/icon.png']
}

tasks.withType(JavaExec) {
    if (System.getProperty('os.name').toLowerCase().contains('mac')) {
        jvmArgs '-Xdock:name=OllamaFX'
        jvmArgs "-Xdock:icon=${project.projectDir}/src/main/resources/icons/icon.png"
    }
}

processResources {
    filesMatching('**/*.properties') {
        expand(project.properties)
    }
}

shadowJar {
    archiveFileName.set('OllamaFX.jar')
    mergeServiceFiles()
    exclude 'module-info.class'
    manifest {
        attributes 'Main-Class': 'com.org.ollamafx.Main'
    }
}

task packageDistribution(type: Zip) {
    dependsOn shadowJar
    dependsOn startShadowScripts
    archiveFileName = "OllamaFX-${version}-Dist.zip"
    destinationDirectory = file("$buildDir/distributions")

    // 1. Put the JAR in lib/
    from(shadowJar.archiveFile) {
        into "lib"
    }
    
    // 2. Prepare scripts: Patch them to work from root (remove 'cd ..' logic)
    // We use a temporary directory to patch files before zipping to avoid modifying original build artifacts repeatedly
    def patchedScriptsDir = file("$buildDir/scriptsPatched")
    
    doFirst {
        patchedScriptsDir.mkdirs()
        
        // Copy and patch the scripts
        copy {
            from "$buildDir/scriptsShadow"
            into patchedScriptsDir
            filter { line ->
                // The generated script does `cd "dirname \"$PRG\"`/.." to find APP_HOME
                // We want APP_HOME to be the script's directory, so we remove the `cd ..` part
                // Standard line: cd "`dirname \"$PRG\"`/.." >/dev/null
                if (line.contains('cd "`dirname \\"$PRG\\"`/.."')) {
                    return 'cd "`dirname \\"$PRG\\"`" >/dev/null' 
                }
                // Windows batch: pushd %DIRNAME%..
                if (line.contains('pushd %DIRNAME%..')) {
                    return 'pushd %DIRNAME%'
                }
                return line
            }
        }
    }

    // 3. Include patched linux script as defaults
    from(patchedScriptsDir) {
        include "OllamaFX"
        into "."
    }

     // 4. Include patched bat script
    from(patchedScriptsDir) {
        include "OllamaFX.bat"
        into "."
    }

    // 5. Create specific extensions from the patched unix script
    from(patchedScriptsDir) {
        include "OllamaFX"
        rename { "OllamaFX.sh" }
        into "."
    }

    from(patchedScriptsDir) {
        include "OllamaFX"
        rename { "OllamaFX.command" }
        into "."
    }

    doLast {
        copy {
            from destinationDirectory
            into "${project.rootDir}/releases"
            include archiveFileName.get()
        }
        println "Release copied to ${project.rootDir}/releases/${archiveFileName.get()}"
    }
}

// Custom jpackage task for Mac
task createInstaller(type: Exec) {
    dependsOn shadowJar
    workingDir project.rootDir
    
    // Command to key inputs:
    // --input build/libs containing the shadow jar
    // --main-jar the shadow jar name
    // --icon the generated icns
    
    commandLine 'jpackage', 
        '--input', 'build/libs',
        '--name', 'OllamaFX',
        '--main-jar', "OllamaFX.jar",
        '--main-class', 'com.org.ollamafx.Main',
        '--type', 'dmg',
        '--icon', 'src/main/resources/icons/icon.icns',
        '--dest', 'releases',
        '--java-options', '--enable-preview' 
        
    doFirst {
        mkdir 'releases'
        println "Creating Installer with icon..."
    }
}
tasks.named('startScripts') {
    dependsOn tasks.named('shadowJar')
}

tasks.named('startShadowScripts') {
    dependsOn tasks.named('jar')
}
